---

- name: Create Buildbot group
  group:
    name: '{{ buildbot_user }}'
    state: present
  become: yes

- name: Create Buildbot user
  user:
    name: '{{ buildbot_user }}'
    password: "{{ lookup('password', '/dev/null encrypt=sha256_crypt length=32') }}"
    update_password: always
    home: "{{ buildbot_home }}"
    shell: /sbin/nologin
    groups:
      - "{{ buildbot_user }}"
      - "docker"
  become: yes
  when: create_buildbot_user

- name: Create Buildbot SSH key directory
  file:
    path: "{{ buildbot_home }}/.ssh"
    owner: "{{ buildbot_user }}"
    group: "{{ buildbot_user }}"
    mode: 0700
    state: directory
  become: yes

- name: Clear current Buildbot user ssh key
  file:
    name: "{{ buildbot_home }}/{{ item }}"
    state: absent
  become: yes
  #Don't clear the key if we're not managing the user for... reasons
  when: create_buildbot_user
  with_items:
    - .ssh/id_rsa
    - .ssh/id_rsa.pub
    - .ssh/authorized_keys
    - .ssh/known_hosts

- name: Generate new Buildbot SSH key
  user:
    name: "{{ buildbot_user }}"
    home: "{{ buildbot_home }}"
    generate_ssh_key: yes
    ssh_key_bits: 4096
  when: create_buildbot_user
  become: yes

